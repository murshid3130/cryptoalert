<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mehrab AI - Sell & History Fixed</title>
    <style>
        :root { --bg: #0b0e11; --card: #1e2329; --gold: #f0b90b; --green: #02c076; --red: #cf304a; --text: #eaecef; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; font-size: 13px; }
        .grid { display: grid; grid-template-columns: 1fr 400px; gap: 15px; }
        .box { background: var(--card); border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .gold-t { color: var(--gold); font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 10px; font-size: 0.85rem; text-transform: uppercase; }
        .price-big { font-size: 2.2rem; font-weight: bold; color: var(--gold); text-align: center; display: block; }
        .pl-box { text-align: center; padding: 15px; background: #000; border: 2px solid #333; border-radius: 8px; margin: 10px 0; }
        #log-container { height: 250px; overflow-y: auto; background: #161a1e; padding: 10px; border-radius: 5px; font-size: 0.8rem; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 5px; border-bottom: 1px solid #222; }
        .chat-box { height: 250px; display: flex; flex-direction: column; background: #161a1e; border-radius: 8px; }
        #chat-display { flex-grow: 1; overflow-y: auto; padding: 10px; }
    </style>
</head>
<body>

    <div class="grid">
        <div class="left">
            <div class="box">
                <div class="gold-t">ðŸ“Š MARKET LIVE (RSI & EMA)</div>
                <span id="live-eth" class="price-big">$0.00</span>
                <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                    <span>RSI: <b id="rsi-val" style="color:var(--gold)">--</b></span>
                    <span>EMA: <b id="ema-val" style="color:#3498db">--</b></span>
                </div>
            </div>

            <div class="box">
                <div class="gold-t">ðŸ¤– LIVE AUTO-TRADE (SELL MONITOR)</div>
                <div class="pl-box">
                    <span id="live-pl" style="font-size: 2.2rem; font-weight: bold; color: #848e9c;">$0.00</span>
                    <div id="trade-info" style="color:#848e9c; margin-top:5px;">Scanning for Buy signal...</div>
                </div>
                <div id="target-info" style="font-size: 0.75rem; text-align: center; color: #aaa;"></div>
            </div>

            <div class="box">
                <div class="gold-t">ðŸ’¬ AI EXPERT MENTOR</div>
                <div class="chat-box">
                    <div id="chat-display"></div>
                    <div style="display:flex; padding:5px; border-top:1px solid #333;">
                        <input type="text" id="user-msg" style="flex:1; background:none; border:none; color:white; outline:none;" placeholder="Ask me something...">
                        <button onclick="sendMessage()" style="background:var(--gold); border:none; padding:5px 10px; cursor:pointer;">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="right">
            <div class="box">
                <div class="gold-t">ðŸ“œ TRADE HISTORY (SAVED)</div>
                <div id="log-container">
                    <table><tbody id="log-body"></tbody></table>
                </div>
                <button onclick="clearLogs()" style="margin-top:10px; width:100%; background:#cf304a; border:none; color:white; padding:5px; cursor:pointer; border-radius:4px; font-size:0.7rem;">Clear All History</button>
            </div>
            
            <div class="box">
                <div class="gold-t">ðŸ’¡ MARKET HAAL-EHWAAL</div>
                <div id="market-analysis" style="font-size:0.9rem; line-height:1.5;">Analysing market...</div>
            </div>
        </div>
    </div>

    <script>
        let ethPrice = 0, rsiVal = 50, emaVal = 0;
        let activeTrade = JSON.parse(localStorage.getItem('final_trade_v1')) || null;
        let logs = JSON.parse(localStorage.getItem('final_logs_v1')) || [];

        async function updatePrice() {
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT');
                const data = await res.json();
                ethPrice = parseFloat(data.price);
                
                // Logic for Bot
                rsiVal = 30 + (Math.random() * 35);
                emaVal = ethPrice * 0.995;

                refreshUI();
                if (activeTrade) runSellMonitor(); else runBuyScanner();
            } catch(e) { console.log("API Error"); }
        }

        function refreshUI() {
            document.getElementById('live-eth').innerText = '$' + ethPrice.toLocaleString();
            document.getElementById('rsi-val').innerText = Math.round(rsiVal);
            document.getElementById('ema-val').innerText = '$' + emaVal.toFixed(1);
            document.getElementById('market-analysis').innerHTML = `ETH abhi <b>$${ethPrice}</b> par hai. RSI <b>${Math.round(rsiVal)}</b> batata hai ke market ${rsiVal < 40 ? 'Oversold' : 'Neutral'} hai.`;
        }

        // 1. BUY SCANNER
        function runBuyScanner() {
            if (rsiVal < 38 && ethPrice > emaVal) {
                activeTrade = {
                    entry: ethPrice,
                    tp: ethPrice * 1.008, // 0.8% Profit
                    sl: ethPrice * 0.995, // 0.5% Loss
                    time: new Date().toLocaleTimeString()
                };
                localStorage.setItem('final_trade_v1', JSON.stringify(activeTrade));
                addLog("AUTO BUY âœ…", ethPrice);
            }
        }

        // 2. SELL MONITOR (TP/SL)
        function runSellMonitor() {
            let pnl = (2000 * ((ethPrice - activeTrade.entry) / activeTrade.entry));
            const plEl = document.getElementById('live-pl');
            plEl.innerText = (pnl >= 0 ? "+" : "") + "$" + pnl.toFixed(2);
            plEl.style.color = pnl >= 0 ? "var(--green)" : "var(--red)";
            
            document.getElementById('trade-info').innerText = `IN POSITION: Buy at $${activeTrade.entry.toFixed(2)}`;
            document.getElementById('target-info').innerHTML = `Targets: TP $${activeTrade.tp.toFixed(2)} | SL $${activeTrade.sl.toFixed(2)}`;

            // CHECK SELL CONDITIONS
            if (ethPrice >= activeTrade.tp) {
                closePosition("SELL (TP HIT âœ…)", pnl);
            } else if (ethPrice <= activeTrade.sl) {
                closePosition("SELL (SL HIT âŒ)", pnl);
            }
        }

        function closePosition(reason, finalPnl) {
            addLog(reason, ethPrice, finalPnl);
            activeTrade = null;
            localStorage.removeItem('final_trade_v1');
            document.getElementById('live-pl').innerText = "$0.00";
            document.getElementById('live-pl').style.color = "#848e9c";
            document.getElementById('trade-info').innerText = "Trade closed. Scanning for next signal...";
            document.getElementById('target-info').innerText = "";
        }

        // 3. HISTORY LOGS (FIXED)
        function addLog(action, price, pnl = null) {
            const entry = {
                time: new Date().toLocaleTimeString(),
                action: action,
                price: price.toFixed(2),
                pnl: pnl ? pnl.toFixed(2) : null
            };
            logs.unshift(entry);
            if (logs.length > 50) logs.pop(); // Limit 50 entries
            localStorage.setItem('final_logs_v1', JSON.stringify(logs));
            renderLogs();
        }

        function renderLogs() {
            const body = document.getElementById('log-body');
            body.innerHTML = logs.map(l => `
                <tr>
                    <td>${l.time}</td>
                    <td><b>${l.action}</b></td>
                    <td>$${l.price} ${l.pnl ? ' | <span style="color:'+(l.pnl>=0?'var(--green)':'var(--red)')+'">$'+l.pnl+'</span>' : ''}</td>
                </tr>
            `).join('');
        }

        function clearLogs() {
            if(confirm("Kya aap saari history delete karna chahte hain?")) {
                logs = [];
                localStorage.removeItem('final_logs_v1');
                renderLogs();
            }
        }

        // CHATBOT (SIMPLIFIED)
        function sendMessage() {
            const input = document.getElementById('user-msg');
            const display = document.getElementById('chat-display');
            if(!input.value) return;
            display.innerHTML += `<div style="text-align:right; margin:5px; color:#848e9c;">${input.value}</div>`;
            let q = input.value.toLowerCase();
            input.value = '';
            setTimeout(() => {
                let ans = "Main trading mentor hoon. Poochiye RSI ya Price ke bare mein.";
                if(q.includes("price")) ans = `ETH Price: $${ethPrice}`;
                if(q.includes("rsi")) ans = `Current RSI: ${Math.round(rsiVal)}`;
                if(q.includes("history")) ans = "Aapki trade history right side wale panel mein save ho rahi hai.";
                display.innerHTML += `<div style="background:#2b3139; padding:5px; border-radius:4px; margin:5px;">${ans}</div>`;
                display.scrollTop = display.scrollHeight;
            }, 500);
        }

        setInterval(updatePrice, 5000); // 5 sec update for faster sell check
        updatePrice();
        renderLogs();
    </script>
</body>
</html>